{% extends "base.html" %}

{% block title %}å‘¨è¯¾è¡¨ - å­¦ç”Ÿè€ƒå‹¤ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}å‘¨è¯¾è¡¨{% endblock %}
{% block page_desc %}æŸ¥çœ‹å½“å‰å­¦æœŸçš„è¯¾ç¨‹å®‰æ’{% endblock %}

{% block content %}
<style>
  .course-card {
    padding: 8px;
    border-radius: 6px;
    font-size: 12px;
    line-height: 1.45;
    color: #111;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  .course-card:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .course-card .name {
    font-weight: bold;
    font-size: 13px;
    margin-bottom: 4px;
    color: #111;
  }
  .course-card .meta {
    font-size: 11px;
    opacity: 0.8;
    margin-top: 2px;
  }
</style>

<!-- ç­›é€‰å’Œæ§åˆ¶æ  -->
<div class="bg-white rounded-xl p-4 card-shadow mb-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h2 class="text-lg font-semibold text-gray-800">{{ semester_title }}</h2>
      <div class="text-sm text-gray-500 mt-1">{{ week_label }}</div>
    </div>
    
    <div class="flex flex-wrap items-center gap-3">
      <!-- å­¦æœŸé€‰æ‹© -->
      {% if semesters %}
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-600">å­¦æœŸ:</label>
        <select id="semester-select" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary">
          {% for semester in semesters %}
          <option value="{{ semester }}" {% if semester == current_semester %}selected{% endif %}>{{ semester }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      
      <!-- å‘¨æ¬¡é€‰æ‹© -->
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-600">å‘¨æ¬¡:</label>
        <div class="flex items-center gap-2">
          <button onclick="changeWeek({{ week_no - 1 }})" 
                  class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-md text-sm transition-colors"
                  {% if week_no <= 1 %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>
            <i class="fa fa-chevron-left"></i>
          </button>
          <input type="number" id="week-input" value="{{ week_no }}" min="1" max="20" 
                 class="w-16 px-2 py-2 border border-gray-300 rounded-md text-sm text-center focus:outline-none focus:ring-2 focus:ring-primary">
          <button onclick="changeWeek({{ week_no + 1 }})" 
                  class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-md text-sm transition-colors"
                  {% if week_no >= 20 %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>
            <i class="fa fa-chevron-right"></i>
          </button>
        </div>
      </div>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <div class="flex items-center gap-2">
        <button onclick="goToCurrentWeek()" 
                class="px-4 py-2 bg-primary text-white rounded-md text-sm hover:bg-primary/90 transition-colors">
          <i class="fa fa-calendar"></i> æœ¬å‘¨
        </button>
        <a href="{{ url_for('course.index') }}" 
           class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md text-sm hover:bg-gray-200 transition-colors">
          <i class="fa fa-list"></i> è¯¾ç¨‹åˆ—è¡¨
        </a>
      </div>
    </div>
  </div>
</div>

<!-- è¯¾è¡¨è¡¨æ ¼ -->
<div class="bg-white rounded-xl card-shadow overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 border-collapse">
      <thead class="bg-gray-100">
        <tr>
          <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider w-28 md:w-32 sticky left-0 bg-gray-100 z-10">
            èŠ‚æ¬¡
          </th>
          
          {% for day_label in day_headers %}
          <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">
            {{ day_label }}
          </th>
          {% endfor %}
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
        {% for row in row_slots %}
        <tr class="h-36">
          <td class="px-4 py-3 text-center border-r border-gray-200 sticky left-0 bg-white z-10">
            <div class="font-semibold text-gray-800">{{ row.label }}</div>
            <div class="text-xs text-gray-500 mt-1">{{ row.time }}</div>
          </td>

          {% for day_idx in range(7) %}
            {% set cell_key = "{}-{}".format(day_idx, row.slot_index) %}
            {% set courses_in_cell = week_grid.get(cell_key, []) %}

            <td class="p-2 border-l border-gray-100 align-top relative
                       {% if courses_in_cell|length == 0 %}bg-gray-50 bg-opacity-50{% endif %}">
              
              <div class="space-y-1.5">
                {% for course in courses_in_cell %}
                {% set min_height = course.span_slots * 36 if course.span_slots > 1 else '' %}
                <div class="course-card" 
                     style="background-color: {{ course.color_bg }}{% if min_height %}; min-height: {{ min_height }}px{% endif %}" 
                     title="è¯¾ç¨‹: {{ course.name }}&#10;æ•™å¸ˆ: {{ course.teacher }}&#10;åœ°ç‚¹: {{ course.place }}&#10;æ—¶é—´: {{ course.raw_time }}&#10;å‘¨æ¬¡: {{ course.week_range }}"
                     data-course-id="{{ course.course_id }}"
                     onclick="window.location.href='{{ url_for('course.detail', course_id=course.course_id) }}'">
                  <div class="name" title="{{ course.name }}">{{ course.name }}</div>
                  <div class="meta">ğŸ“ {{ course.place }}</div>
                  <div class="meta">ğŸ‘¤ {{ course.teacher }}</div>
                  {% if course.week_range and course.week_range != "å…¨å­¦æœŸ" %}
                  <div class="meta">ğŸ“… {{ course.week_range }}</div>
                  {% endif %}
                  {% if course.start_period and course.end_period and course.end_period > course.start_period %}
                  <div class="meta">â° {{ course.start_period }}-{{ course.end_period }}èŠ‚</div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
              
            </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // å‘¨æ¬¡é€‰æ‹©åŠŸèƒ½
  function changeWeek(week) {
    if (week < 1 || week > 20) return;
    
    const semester = document.getElementById('semester-select')?.value || '';
    const params = new URLSearchParams();
    params.set('week', week);
    if (semester) {
      params.set('semester', semester);
    }
    window.location.href = '{{ url_for("upcoming.upcoming_week_page") }}?' + params.toString();
  }
  
  // è·³è½¬åˆ°æœ¬å‘¨
  function goToCurrentWeek() {
    const semester = document.getElementById('semester-select')?.value || '';
    const params = new URLSearchParams();
    if (semester) {
      params.set('semester', semester);
    }
    window.location.href = '{{ url_for("upcoming.upcoming_week_page") }}?' + params.toString();
  }
  
  // å­¦æœŸé€‰æ‹©å˜åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    const semesterSelect = document.getElementById('semester-select');
    if (semesterSelect) {
      semesterSelect.addEventListener('change', function() {
        const week = document.getElementById('week-input').value;
        const params = new URLSearchParams();
        params.set('semester', this.value);
        params.set('week', week);
        window.location.href = '{{ url_for("upcoming.upcoming_week_page") }}?' + params.toString();
      });
    }
    
    // å‘¨æ¬¡è¾“å…¥æ¡†å˜åŒ–
    const weekInput = document.getElementById('week-input');
    if (weekInput) {
      weekInput.addEventListener('change', function() {
        let week = parseInt(this.value);
        if (week < 1) week = 1;
        if (week > 20) week = 20;
        changeWeek(week);
      });
    }
  });
</script>
{% endblock %}
