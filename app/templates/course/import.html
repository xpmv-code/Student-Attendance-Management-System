{% extends "base.html" %}

{% block title %}导入课程 - 学生考勤管理系统{% endblock %}

{% block page_title %}ICS文件导入课程{% endblock %}
{% block page_desc %}从日历文件批量导入课程信息{% endblock %}

{% block content %}
<!-- Flash消息显示 -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="space-y-2 mb-6">
            {% for category, message in messages %}
                <div class="flex items-center p-4 rounded-lg {% if category == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif category == 'error' %}bg-red-50 text-red-800 border border-red-200{% else %}bg-yellow-50 text-yellow-800 border border-yellow-200{% endif %}">
                    <i class="fa {% if category == 'success' %}fa-check-circle{% elif category == 'error' %}fa-times-circle{% else %}fa-exclamation-circle{% endif %} mr-2"></i>
                    <span>{{ message }}</span>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 上传表单 -->
    <div class="bg-white rounded-xl p-6 card-shadow">
        <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-upload text-primary mr-2"></i>
            上传ICS文件
        </h3>
        
        <form method="POST" enctype="multipart/form-data" id="uploadForm">
            <!-- 文件上传区域 -->
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors mb-6">
                <input 
                    type="file" 
                    id="file" 
                    name="file" 
                    accept=".ics"
                    required
                    class="hidden"
                    onchange="handleFileSelect(this)"
                >
                <label for="file" class="cursor-pointer">
                    <i class="fa fa-calendar text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-600 mb-2">点击选择ICS文件</p>
                    <p class="text-sm text-gray-500">支持 .ics 格式的日历文件</p>
                </label>
                <div id="fileInfo" class="hidden mt-4">
                    <p class="text-sm text-gray-700">
                        已选择：<span id="fileName" class="font-medium text-primary"></span>
                    </p>
                </div>
            </div>

            <!-- 按钮组 -->
            <div class="flex gap-4">
                <button 
                    type="submit"
                    class="flex-1 bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium"
                >
                    <i class="fa fa-upload mr-2"></i>
                    开始导入
                </button>
                <a 
                    href="{{ url_for('course.index') }}"
                    class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors font-medium text-center"
                >
                    <i class="fa fa-times mr-2"></i>
                    取消
                </a>
            </div>
        </form>
    </div>

    <!-- 格式说明 -->
    <div class="space-y-6">
        <!-- ICS格式说明 -->
        <div class="bg-white rounded-xl p-6 card-shadow">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-info-circle text-secondary mr-2"></i>
                ICS文件格式说明
            </h3>
            <div class="space-y-3 text-sm">
                <div class="flex items-start">
                    <i class="fa fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                    <div>
                        <p class="font-medium text-gray-900">标准日历格式</p>
                        <p class="text-gray-600">支持 iCalendar (.ics) 标准格式文件</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fa fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                    <div>
                        <p class="font-medium text-gray-900">自动解析</p>
                        <p class="text-gray-600">自动提取课程代码、名称、教师、时间、地点</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fa fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                    <div>
                        <p class="font-medium text-gray-900">智能去重</p>
                        <p class="text-gray-600">按课程代码合并，避免重复导入</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fa fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                    <div>
                        <p class="font-medium text-gray-900">更新支持</p>
                        <p class="text-gray-600">课程代码已存在时将更新课程信息</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ICS文件示例 -->
        <div class="bg-white rounded-xl p-6 card-shadow">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-code text-amber-500 mr-2"></i>
                ICS文件结构示例
            </h3>
            <div class="bg-gray-50 p-4 rounded-lg text-xs font-mono overflow-x-auto">
<pre class="text-gray-700">BEGIN:VEVENT
SUMMARY:体育科学研究方法（必修课）
DTSTART;TZID=Asia/Shanghai:20251104T082000
DTEND;TZID=Asia/Shanghai:20251104T095000
DESCRIPTION:课程代码: 010345\n教师: 王丽芳
  鄠邑校区 教学楼304\n周次: 10
LOCATION:教学楼304
END:VEVENT</pre>
            </div>
        </div>

        <!-- 预期解析结果 -->
        <div class="bg-white rounded-xl p-6 card-shadow">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-table text-blue-500 mr-2"></i>
                预期解析结果
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-200 text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="border border-gray-200 px-3 py-2 text-left font-medium">课程代码</th>
                            <th class="border border-gray-200 px-3 py-2 text-left font-medium">课程名称</th>
                            <th class="border border-gray-200 px-3 py-2 text-left font-medium">教师</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border border-gray-200 px-3 py-2">010345</td>
                            <td class="border border-gray-200 px-3 py-2">体育科学研究方法</td>
                            <td class="border border-gray-200 px-3 py-2">王丽芳</td>
                        </tr>
                        <tr>
                            <td class="border border-gray-200 px-3 py-2">040491</td>
                            <td class="border border-gray-200 px-3 py-2">运动生物化学</td>
                            <td class="border border-gray-200 px-3 py-2">冯晓磊</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 注意事项 -->
        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
            <div class="flex">
                <i class="fa fa-exclamation-triangle text-amber-600 mr-3 mt-0.5"></i>
                <div class="text-sm text-amber-800">
                    <p class="font-medium mb-2">注意事项：</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>确保ICS文件包含完整的课程信息</li>
                        <li>文件中的事件描述需包含课程代码</li>
                        <li>导入前建议先用少量数据测试</li>
                        <li>重复的课程代码将更新原有记录</li>
                        <li>导入过程可能需要几秒钟，请耐心等待</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const fileName = input.files[0].name;
            const fileSize = (input.files[0].size / 1024).toFixed(2); // KB
            
            document.getElementById('fileName').textContent = `${fileName} (${fileSize} KB)`;
            document.getElementById('fileInfo').classList.remove('hidden');
        }
    }

    // 表单提交验证
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        const fileInput = document.getElementById('file');
        if (!fileInput.files || !fileInput.files[0]) {
            e.preventDefault();
            alert('请选择要上传的ICS文件');
            return false;
        }

        // 显示加载提示
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>正在导入...';
    });
</script>
{% endblock %}

