# 考勤记录模块测试指南

## 环境准备

### 1. 安装依赖

考勤记录模块已在 `requirements.txt` 中包含了所需依赖，确保已安装：

```bash
cd /Users/xpmv-mac/PycharmProjects/class
pip install -r requirements.txt
```

关键依赖：
- `openpyxl==3.1.2` - Excel 文件处理
- `icalendar==5.0.11` - ICS 文件处理（课程导入用）

### 2. 启动应用

```bash
flask run
```

应用将运行在 `http://127.0.0.1:5000`

## 测试步骤

### 第一步：准备测试数据

#### 1. 导入学生数据（如果还没有）

1. 访问：`http://127.0.0.1:5000/student/`
2. 点击"导入Excel"
3. 准备一个 Excel 文件，格式如下：

| A列(学号) | B列(姓名) | C列(政治面貌) | D列(联系电话) |
|-----------|-----------|---------------|---------------|
| 230108001 | 张三      | 共青团员      | 13800138001   |
| 230108002 | 李四      | 群众          | 13800138002   |
| 230108003 | 王五      | 预备党员      | 13800138003   |

4. 上传并导入

#### 2. 导入课程数据（如果还没有）

1. 访问：`http://127.0.0.1:5000/course/`
2. 点击"导入ICS文件"
3. 上传课程的 `.ics` 文件（如 `230108.ics`）
4. 确认导入

### 第二步：测试考勤日历视图

#### 访问考勤日历

1. 点击左侧导航"考勤记录"或访问 `http://127.0.0.1:5000/attendance/`
2. 应该看到：
   - ✅ 当前日期显示正确（如：2025年10月25日 周六）
   - ✅ 日期导航按钮（前一天、后一天、今天）
   - ✅ 本周日历（显示周一到周日）
   - ✅ 当天课程列表（如果有课）

#### 测试日期切换

1. 点击"前一天"按钮，日期应该变为前一天
2. 点击"后一天"按钮，日期应该变为后一天
3. 点击"今天"按钮，日期应该回到今天
4. 点击本周日历中的某一天，应该跳转到该日期

**预期结果：**
- ✅ 日期切换流畅
- ✅ URL 参数正确（如：`?date=2025-10-25`）
- ✅ 课程列表根据日期动态变化

#### 查看课程考勤统计

如果当天有课程，应该显示：
- ✅ 课程基本信息（名称、时间、地点、教师、学期）
- ✅ 考勤统计（应到、实到、请假、旷课、到勤率）
- ✅ 记录状态标签（已记录/未记录）
- ✅ "记录考勤"或"编辑考勤"按钮

### 第三步：测试考勤记录功能

#### 首次记录考勤

1. 在日历视图中，选择一个有课程的日期
2. 点击某节课的"记录考勤"按钮
3. 系统应该：
   - ✅ 显示 Flash 消息："已为该课程创建默认考勤记录（所有学生到课）"
   - ✅ 自动跳转到考勤记录编辑页面
   - ✅ 所有学生的考勤状态默认为"到课"

#### 编辑考勤记录

在考勤记录编辑页面：

1. **查看页面元素**：
   - ✅ 面包屑导航（考勤日历 > 考勤记录）
   - ✅ 课程信息（名称、日期、时间、地点）
   - ✅ 操作提示（蓝色提示框）
   - ✅ 快捷操作按钮（全部到课、全部请假、全部旷课）
   - ✅ 学生考勤表格
   - ✅ 统计面板（总人数、到课、请假、旷课）

2. **测试快捷操作**：
   - 点击"全部请假"：所有学生状态变为"请假"
   - 统计面板实时更新（请假人数 = 总人数，其他为 0）
   - 点击"全部旷课"：所有学生状态变为"旷课"
   - 统计面板更新（旷课人数 = 总人数）
   - 点击"全部到课"：恢复为全部到课
   - ✅ 快捷操作按钮工作正常

3. **测试单个修改**：
   - 将第一个学生改为"请假"
   - 统计面板应显示：请假人数 = 1，到课人数 = 总数 - 1
   - 为第二个学生设置迟到时长：输入 10（分钟）
   - 为第三个学生添加备注："家中有事"
   - ✅ 修改实时反映在统计面板

4. **保存记录**：
   - 点击"保存考勤记录"
   - 弹出确认对话框："确定要保存考勤记录吗？"
   - 点击"确定"
   - 显示 Flash 消息："考勤记录保存成功"
   - 页面保持在编辑页面，可继续修改
   - ✅ 保存成功，数据持久化

5. **返回日历**：
   - 点击"返回"按钮
   - 回到考勤日历视图
   - 该课程的状态标签变为"已记录"
   - 考勤统计数据更新
   - ✅ 数据正确显示

### 第四步：测试历史记录查询

#### 访问历史记录

1. 在考勤日历页面，点击"历史记录"按钮
2. 或访问：`http://127.0.0.1:5000/attendance/history`
3. 应该看到：
   - ✅ 筛选表单（开始日期、结束日期、课程、查询、清空按钮）
   - ✅ 历史考勤记录列表（如果有数据）
   - ✅ 分页导航（如果记录超过 15 条）

#### 测试筛选功能

1. **按日期筛选**：
   - 设置开始日期：2025-10-01
   - 设置结束日期：2025-10-31
   - 点击"查询"
   - ✅ 只显示该日期范围内的记录
   - ✅ 显示筛选提示（当前筛选条件：开始日期 2025-10-01，结束日期 2025-10-31 ｜ 共找到 X 条记录）

2. **按课程筛选**：
   - 选择特定课程（如"高等数学"）
   - 点击"查询"
   - ✅ 只显示该课程的记录
   - ✅ 筛选提示显示课程名称

3. **组合筛选**：
   - 同时设置日期范围和课程
   - 点击"查询"
   - ✅ 显示同时满足两个条件的记录

4. **清空筛选**：
   - 点击"清空"按钮
   - ✅ 返回未筛选状态，显示所有记录

#### 查看记录详情

1. 在历史记录列表中，找到一条记录
2. 查看显示的信息：
   - ✅ 日期格式正确
   - ✅ 课程名称正确
   - ✅ 应到人数 = 学生总数
   - ✅ 实到、请假、旷课人数正确
   - ✅ 到勤率计算正确，颜色标识正确（绿/黄/红）

3. 点击"查看/编辑"链接
4. ✅ 跳转到该课程该日期的考勤记录编辑页面

#### 测试分页

如果历史记录超过 15 条：
1. 应该看到页码导航
2. 点击"下一页"
3. ✅ 显示第二页数据
4. 点击页码（如"3"）
5. ✅ 跳转到第 3 页
6. 点击"上一页"
7. ✅ 返回前一页
8. ✅ 显示当前记录范围（如"显示第 16 到 30 条，共 45 条记录"）

### 第五步：测试导出功能

#### 导出当天考勤

1. 在考勤日历视图，选择一个有课程的日期
2. 点击"导出当天"按钮
3. 应该：
   - ✅ 浏览器自动下载 Excel 文件
   - ✅ 文件名格式：`YYYYMMDD_考勤记录.xlsx`（如：`20251025_考勤记录.xlsx`）

4. 打开下载的 Excel 文件，检查：
   - ✅ 标题：YYYY年MM月DD日 课程考勤记录（居中、加粗）
   - ✅ 表头：课程名称、上课时间、上课地点、应到人数、实到人数、到勤率（蓝底白字）
   - ✅ 数据行：当天所有课程的统计数据
   - ✅ 格式：边框完整，数据居中对齐
   - ✅ 列宽：自动调整，内容可完整显示

#### 导出本周考勤

1. 在考勤日历视图，选择任意日期
2. 点击"导出本周"按钮
3. 应该：
   - ✅ 浏览器自动下载 Excel 文件
   - ✅ 文件名格式：`YYYYMMDD-YYYYMMDD_周考勤统计.xlsx`

4. 打开下载的 Excel 文件，检查：
   - ✅ 标题：YYYY年MM月DD日 - YYYY年MM月DD日 课程考勤统计
   - ✅ 按天分组（如：2025年10月21日 周一）
   - ✅ 每天的表头：课程名称、上课时间、上课地点、应到、实到、请假、旷课
   - ✅ 每天的数据行：该天所有课程的详细考勤数据
   - ✅ 日期标题（浅蓝底）
   - ✅ 各天之间有空行分隔
   - ✅ 格式：边框完整，数据居中对齐

### 第六步：综合测试场景

#### 场景1：记录一周的考勤

1. 从本周一开始，逐天记录考勤
2. 每天选择不同的考勤状态组合（如：周一全到课，周二有2人请假，周三有1人旷课）
3. 记录完成后，导出本周考勤
4. ✅ 导出的 Excel 文件应包含所有记录的数据

#### 场景2：修改历史考勤

1. 在历史记录中找到一条记录
2. 点击"查看/编辑"
3. 修改某些学生的考勤状态
4. 保存
5. 返回历史记录，刷新页面
6. ✅ 统计数据已更新

#### 场景3：无课程日期

1. 选择一个没有课程的日期（如周末）
2. ✅ 应显示"当天没有课程"提示
3. ✅ 导出当天按钮仍可用，但生成的 Excel 文件应提示"该日期没有课程"

#### 场景4：首页集成测试

1. 访问首页 `http://127.0.0.1:5000/`
2. 查看"今日考勤"数字
3. 点击"查看详情"链接
4. ✅ 跳转到考勤日历（今天）
5. 点击首页"快捷操作"中的"记录考勤"
6. ✅ 跳转到考勤日历
7. 查看首页"最近考勤记录"
8. 点击"查看全部"
9. ✅ 跳转到历史记录查询页面

## 常见问题排查

### 问题1：考勤记录保存失败

**现象**：点击保存后提示"保存失败"

**排查步骤**：
1. 检查数据库连接是否正常
2. 查看终端错误日志
3. 确认学生和课程数据已存在
4. 检查日期格式是否正确

### 问题2：导出的 Excel 文件打不开

**现象**：下载的文件无法用 Excel 打开

**排查步骤**：
1. 确认 `openpyxl` 已正确安装
2. 检查是否有课程数据
3. 查看浏览器控制台错误
4. 尝试用 WPS 或 LibreOffice 打开

### 问题3：考勤统计数据不正确

**现象**：到勤率计算错误或统计人数不匹配

**排查步骤**：
1. 确认学生总数
2. 检查考勤状态是否为标准值（到课/请假/旷课）
3. 刷新页面重新加载数据
4. 查看数据库中的实际记录

### 问题4：日期切换后页面空白

**现象**：切换日期后没有显示课程

**排查步骤**：
1. 确认该日期是否有课程
2. 检查课程数据的 `course_time` 字段格式
3. 查看终端是否有查询错误
4. 手动查询数据库验证数据

## 性能测试建议

1. **大量学生测试**：
   - 导入 100+ 学生
   - 记录考勤，观察页面加载速度
   - 测试统计计算性能

2. **大量历史记录测试**：
   - 创建 50+ 条历史记录
   - 测试分页功能
   - 测试筛选查询速度

3. **并发操作测试**：
   - 多个浏览器同时访问
   - 同时编辑不同课程的考勤
   - 同时导出数据

## 测试完成检查清单

- [ ] 考勤日历视图正常显示
- [ ] 日期切换功能正常
- [ ] 周历导航功能正常
- [ ] 首次记录考勤自动创建默认记录
- [ ] 考勤记录编辑页面正常显示
- [ ] 快捷操作按钮（全部到课/请假/旷课）正常
- [ ] 单个学生考勤状态修改正常
- [ ] 实时统计面板数据正确
- [ ] 考勤记录保存成功
- [ ] 历史记录查询功能正常
- [ ] 日期筛选功能正常
- [ ] 课程筛选功能正常
- [ ] 分页功能正常
- [ ] 导出当天考勤功能正常
- [ ] 导出本周考勤功能正常
- [ ] 导出的 Excel 文件格式正确
- [ ] 首页集成测试正常

## 下一步

考勤记录模块测试完成后，可以继续开发：
1. **请假管理**：学生请假申请、审批、与考勤关联
2. **数据分析**：个人出勤统计、课程出勤趋势、异常考勤分析
3. **通知提醒**：旷课提醒、低出勤率预警
4. **权限管理**：区分教师、学生、管理员角色

祝测试顺利！🎉

