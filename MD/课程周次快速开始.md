# 课程周次功能 - 快速开始

## 🚀 快速上手（3分钟）

### 步骤1：数据库迁移

执行SQL迁移脚本，为 `course` 表添加 `week_range` 字段：

```bash
# 方式1：使用psql命令
psql -U your_username -d your_database -f migrations/add_week_range_to_course.sql

# 方式2：在PostgreSQL客户端中执行
ALTER TABLE course ADD COLUMN IF NOT EXISTS week_range VARCHAR(50);
```

### 步骤2：重新导入课程

1. **访问课程管理页面**：
   ```
   http://127.0.0.1:5000/course/
   ```

2. **点击"导入ICS文件"**

3. **上传包含周次信息的ICS文件**（如：`230108.ics`）

4. **系统会自动**：
   - 解析每个课程的所有上课周次
   - 生成 `week_range` 字符串（如：`1-8` 或 `9-16`）
   - 保存到数据库

### 步骤3：测试功能

#### 测试1：运行测试脚本

```bash
python test_week_functionality.py
```

应该看到所有测试通过 ✅

#### 测试2：访问考勤日历

```
http://127.0.0.1:5000/attendance/
```

**验证：**
- 如果今天是第1周周一，应该显示 `week_range` 包含"1"的周一课程
- 如果今天是第9周周一，应该显示 `week_range` 包含"9"的周一课程

## 📝 核心概念

### 学期配置

**第一周开始日期**：`2025年9月1日`

这个日期在 `app/utils/week_helper.py` 中配置：
```python
FIRST_WEEK_START = date(2025, 9, 1)
```

### 周次范围格式

| 格式 | 说明 | 示例 |
|------|------|------|
| `1-8` | 连续范围 | 第1周到第8周 |
| `9-16` | 连续范围 | 第9周到第16周 |
| `1-8,13,15,17` | 组合 | 第1-8周，第13、15、17周 |
| `1,3,5,7,9` | 不连续 | 只在第1、3、5、7、9周 |
| 空或NULL | 全学期 | 每周都上课 |

### 智能过滤

**考勤日历自动过滤逻辑：**

```
1. 用户访问某个日期（如：2025-09-08）
2. 系统计算是第几周（第2周）
3. 系统查询该星期几的课程（如：周一的课）
4. 系统过滤：只显示 week_range 包含"2"的课程
5. 显示结果
```

**示例：**

假设数据库中有：
```
高等数学    周一 08:00-09:40    week_range: 1-16
大学英语    周一 10:00-11:40    week_range: 1-8
专业选修    周一 14:00-15:40    week_range: 9-16
```

访问不同周次的结果：
- **第2周周一**：显示 高等数学、大学英语（都包含"2"）
- **第9周周一**：显示 高等数学、专业选修（都包含"9"）

## 🎯 典型使用场景

### 场景1：课程分两个阶段

**需求**：课程前8周上理论课，后8周上实验课

**解决方案**：
创建两门课程：
```python
# 理论课
course1 = Course(
    course_id='CS101-1',
    course_name='数据结构（理论）',
    teacher_name='张老师',
    course_time='周一 08:00-09:40',
    course_place='教学楼A201',
    week_range='1-8'
)

# 实验课
course2 = Course(
    course_id='CS101-2',
    course_name='数据结构（实验）',
    teacher_name='李老师',
    course_time='周一 08:00-09:40',
    course_place='实验楼B302',
    week_range='9-16'
)
```

### 场景2：隔周上课

**需求**：课程只在单周（或双周）上课

**解决方案**：
```python
# 单周上课
course = Course(
    course_id='CS102',
    course_name='专题讲座',
    week_range='1,3,5,7,9,11,13,15'
)

# 双周上课
course = Course(
    course_id='CS103',
    course_name='实践课程',
    week_range='2,4,6,8,10,12,14,16'
)
```

### 场景3：特定周次的课程

**需求**：课程只在特定的几周上课

**解决方案**：
```python
course = Course(
    course_id='CS104',
    course_name='期中复习',
    week_range='7,8,9'  # 只在第7、8、9周上课
)
```

## ⚙️ 配置修改

### 修改学期开始日期

编辑 `app/utils/week_helper.py`：
```python
# 将第一周开始日期改为你的实际开学日期
FIRST_WEEK_START = date(2025, 9, 1)  # 修改这里
```

### 修改最大周次数

编辑 `app/utils/week_helper.py` 中的 `get_week_number` 函数：
```python
def get_week_number(target_date):
    # ...
    
    # 一般学期最多20周，如需修改：
    if week_number > 25:  # 改为25周
        return None
    
    return week_number
```

## 🔍 故障排查

### 问题1：课程不显示

**可能原因：**
1. `week_range` 字段为空 → 课程会显示
2. `week_range` 不包含当前周次 → 课程不显示（正常）
3. 学期开始日期配置错误 → 周次计算错误

**解决方法：**
```python
# 检查课程数据
from app.models import Course
from app.utils.week_helper import get_week_number
from datetime import date

course = Course.query.first()
print(f"课程: {course.course_name}")
print(f"周次范围: {course.week_range}")

today_week = get_week_number(date.today())
print(f"今天是第{today_week}周")
print(f"今天是否上课: {course.is_teaching_week(today_week)}")
```

### 问题2：所有课程都不显示

**可能原因：**
当前日期不在学期范围内（第1-20周）

**解决方法：**
```python
from app.utils.week_helper import get_week_number, FIRST_WEEK_START
from datetime import date

today = date.today()
week = get_week_number(today)
print(f"学期开始日期: {FIRST_WEEK_START}")
print(f"今天: {today}")
print(f"今天是第{week}周")

if week is None:
    print("⚠️ 当前日期不在学期范围内")
```

### 问题3：导入ICS后week_range为空

**可能原因：**
ICS文件中没有"周次: X"信息

**解决方法：**
手动设置 `week_range`：
```python
from app.models import Course
from app import db

# 将所有课程设置为全学期
courses = Course.query.filter(Course.week_range == None).all()
for course in courses:
    course.week_range = '1-16'
db.session.commit()
```

## 📚 参考文档

- **详细说明**：`课程周次功能说明.md`
- **测试脚本**：`test_week_functionality.py`
- **数据库迁移**：`migrations/add_week_range_to_course.sql`

## ✅ 检查清单

完成以下检查，确保功能正常：

- [ ] 数据库已添加 `week_range` 字段
- [ ] 已重新导入ICS文件
- [ ] 测试脚本全部通过
- [ ] 考勤日历能正确过滤课程
- [ ] 导出功能正常工作
- [ ] 学期开始日期配置正确

## 🎉 完成！

现在您的考勤系统已经支持课程周次管理了！系统会自动根据当前周次显示应该上课的课程。

