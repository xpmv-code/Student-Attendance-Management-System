# 课程管理功能说明

## ✨ 新增功能

### 1. ICS文件导入课程

#### 功能特点
- **自动解析**：从 ICS 日历文件自动提取课程信息
- **智能去重**：按课程代码合并，避免重复导入
- **批量导入**：一次性导入整个学期的所有课程
- **更新支持**：课程代码已存在时自动更新信息

#### 支持的信息提取
- 课程代码（从 DESCRIPTION 中解析）
- 课程名称（自动去除必修/选修标识）
- 授课教师
- 上课时间（自动计算星期和时间）
- 上课地点
- 学期信息

#### 使用方法
1. 准备 ICS 格式的课程表文件
2. 进入"课程管理"页面
3. 点击"导入ICS"按钮
4. 选择 ICS 文件
5. 点击"开始导入"
6. 查看导入结果统计

---

### 2. 课程列表管理

#### 显示信息
- 课程代码
- 课程名称
- 授课教师
- 上课时间和地点
- 考勤记录数
- **到勤率**（实时计算）

#### 筛选功能
- **关键词搜索**：按课程代码、课程名称或教师姓名搜索
- **学期筛选**：快速查看特定学期的课程
- **分页显示**：每页10门课程

#### 到勤率颜色标识
- 🟢 绿色：≥ 90%（优秀）
- 🟡 黄色：70% - 89%（良好）
- 🔴 红色：< 70%（需关注）
- ⚪ 灰色：无数据

---

### 3. 课程详情与考勤统计

#### 课程基本信息
- 课程代码和名称
- 授课教师
- 上课时间
- 上课地点
- 所属学期

#### 考勤统计卡片
- **总记录数**：该课程的所有考勤记录
- **正常**：正常出勤人次
- **迟到**：迟到人次
- **早退**：早退人次
- **缺席**：缺席人次
- **请假**：请假人次
- **出勤率**：正常出勤 ÷ 总记录数

#### 考勤记录列表
显示该课程的所有考勤记录：
- 学号、姓名
- 考勤日期
- 考勤状态（带颜色标识）
- 迟到分钟数
- 备注信息

#### 日期筛选
- 可按特定日期筛选考勤记录
- 下拉框显示所有有考勤记录的日期
- 一键清除筛选条件

---

### 4. 导出考勤功能

#### 导出格式
- 文件格式：`.xlsx`（Excel）
- 文件命名：`[课程名称]_考勤记录_[日期]_[时间戳].xlsx`

#### 导出内容
**表头信息：**
- 课程名称（合并单元格，居中显示）
- 教师、上课时间、地点（信息栏）

**数据字段：**
| 字段 | 说明 |
|------|------|
| 学号 | 学生学号 |
| 姓名 | 学生姓名 |
| 考勤日期 | YYYY-MM-DD |
| 考勤状态 | 带颜色标识（绿/黄/橙/红/蓝）|
| 迟到分钟 | 仅迟到状态有值 |
| 备注 | 考勤备注信息 |
| 记录时间 | 创建时间戳 |

#### 状态颜色
- 🟢 正常：浅绿色背景
- 🟡 迟到：浅黄色背景
- 🔴 缺席：浅红色背景

#### 导出方式
1. **课程详情页导出**：
   - 可导出该课程所有考勤记录
   - 可按日期筛选后导出

2. **今日考勤导出**：
   - 每门课程独立导出
   - 自动包含今日日期标识

---

### 5. 今日考勤概览

#### 功能特点
- 展示今日所有课程的考勤情况
- 每门课程独立卡片显示
- 彩色渐变头部设计
- 出勤率大徽章显示

#### 显示信息
**课程头部：**
- 课程名称、代码
- 教师姓名
- 上课时间和地点
- 出勤率徽章（大字号显示）

**统计数据：**
- 总人数
- 正常人数（绿色）
- 迟到人数（黄色）
- 缺席人数（红色）

**详细记录表：**
- 学号、姓名、政治面貌
- 考勤状态（彩色标签）
- 迟到分钟数
- 备注信息

#### 快捷操作
- 查看详情：跳转到课程详情页
- 导出考勤：导出该课程今日考勤

---

## 📊 使用场景

### 场景1：学期初导入课程
```
1. 从教务系统导出课程表 ICS 文件
2. 进入系统，点击"课程管理" → "导入ICS"
3. 上传 ICS 文件
4. 系统自动解析并导入所有课程
5. 查看导入结果，确认课程信息
```

### 场景2：查看某门课程到勤率
```
1. 进入"课程管理"页面
2. 在列表中找到目标课程
3. 查看"到勤率"列的百分比
4. 点击"查看"图标进入详情页
5. 查看详细的考勤统计和记录
```

### 场景3：导出课程考勤记录
```
1. 进入目标课程的详情页
2. （可选）选择特定日期筛选
3. 点击"导出考勤"按钮
4. 获得格式化的 Excel 文件
5. 可用于报告、分析或存档
```

### 场景4：查看今日所有课程考勤
```
1. 点击"课程管理" → "今日考勤"
2. 查看今日所有课程的考勤情况
3. 快速识别出勤率异常的课程
4. 可直接导出或查看详情
```

### 场景5：按学期筛选课程
```
1. 在课程列表页面
2. 选择"学期筛选"下拉框
3. 选择目标学期
4. 查看该学期的所有课程
5. 可进一步搜索或查看详情
```

---

## 🎯 数据统计逻辑

### 到勤率计算公式
```
到勤率 = (正常出勤次数 ÷ 总考勤记录数) × 100%
```

**说明：**
- 只有"正常"状态计入分子
- 所有考勤记录（正常/迟到/早退/缺席/请假）计入分母
- 结果保留1位小数

### 考勤状态定义
| 状态 | 说明 | 颜色 |
|------|------|------|
| 正常 | 按时到达 | 绿色 |
| 迟到 | 晚于规定时间到达 | 黄色 |
| 早退 | 提前离开 | 橙色 |
| 缺席 | 未到课且无请假 | 红色 |
| 请假 | 事先请假批准 | 蓝色 |

---

## 🔧 技术实现

### ICS文件解析
使用 `icalendar` 库解析 ICS 文件：
- 提取 VEVENT 事件
- 解析 SUMMARY（课程名称）
- 解析 DESCRIPTION（课程代码、教师）
- 解析 DTSTART/DTEND（上课时间）
- 解析 LOCATION（上课地点）

### Excel导出
使用 `openpyxl` 库生成 Excel：
- 设置表头样式（蓝色背景、白色粗体）
- 根据考勤状态设置单元格背景色
- 自动调整列宽
- 合并单元格显示课程信息

### 数据库查询优化
- 使用关联查询（JOIN）减少查询次数
- 利用索引加速搜索
- 分页查询避免一次加载过多数据

---

## 📝 注意事项

### ICS导入
1. **文件格式**：确保是标准 iCalendar (.ics) 格式
2. **编码问题**：建议使用 UTF-8 编码
3. **课程代码**：必须在 DESCRIPTION 中包含"课程代码:"字样
4. **重复处理**：相同课程代码会更新而非重复创建

### 考勤数据
1. **数据完整性**：到勤率依赖于考勤记录的完整性
2. **实时更新**：每次查看都实时计算最新数据
3. **历史数据**：删除课程会级联删除所有考勤记录

### 导出功能
1. **数据量**：大量数据导出可能需要几秒钟
2. **文件大小**：考勤记录越多，文件越大
3. **浏览器兼容**：建议使用现代浏览器（Chrome、Edge、Firefox）

---

## 🚀 快速开始

### 1. 安装依赖
```bash
pip install icalendar==5.0.11
```

### 2. 启动系统
```bash
python run.py
```

### 3. 访问课程管理
```
http://localhost:5080/course/
```

### 4. 导入示例课程
提供的 `230108.ics` 文件包含完整的课程表数据，可直接导入测试。

---

## ✅ 功能清单

- [x] ICS文件导入课程
- [x] 课程列表展示
- [x] 课程搜索和筛选
- [x] 到勤率实时计算
- [x] 课程详情查看
- [x] 考勤统计分析
- [x] 按日期筛选考勤
- [x] 导出考勤Excel
- [x] 今日考勤概览
- [x] 课程删除（级联删除考勤）
- [x] 响应式界面设计

---

## 🎨 界面亮点

1. **颜色编码**：到勤率和考勤状态都有直观的颜色标识
2. **卡片设计**：现代化的卡片式布局
3. **渐变效果**：今日考勤页面使用彩色渐变
4. **徽章显示**：出勤率用大号徽章突出显示
5. **表格优化**：鼠标悬停高亮，提升可读性
6. **图标丰富**：Font Awesome图标增强视觉效果

---

**课程管理模块已全部完成，可以开始使用！** 🎉

