# 一周多次上课问题修复

## 问题描述

### 问题1：课程一周多次上课无法正确显示
**现象**：有些课程一周上多次（如周一和周三都有），但系统只显示第一次出现的时间。

**原因**：原来的ICS导入逻辑按课程代码（course_code）去重，导致同一个课程代码的多次上课只保留了第一条记录。

### 问题2：点击"记录考勤"报404错误
**原因**：与问题1相关，可能是course_id不正确导致找不到对应的课程记录。

## 解决方案

### 核心改进：为每个"课程代码+上课时间"创建唯一课程记录

**原逻辑**：
```python
# 按课程代码去重
if course_code not in courses_dict:
    courses_dict[course_code] = {
        'course_id': course_code,  # 只用课程代码作为ID
        ...
    }
```

**新逻辑**：
```python
# 为每个"课程代码+上课时间"创建唯一ID
weekday_num = dtstart.weekday() + 1  # 1-7代表周一到周日
time_code = start_time.replace(':', '')  # 如：08:00 → 0800
unique_key = f"{course_code}-{weekday_num}-{time_code}"

courses_dict[unique_key] = {
    'course_id': unique_key,  # 使用唯一ID
    ...
}
```

### Course ID 格式

**格式**：`课程代码-星期数字-时间代码`

**示例**：
| 课程 | 上课时间 | Course ID |
|------|----------|-----------|
| 高等数学 (CS101) | 周一 08:00 | `CS101-1-0800` |
| 高等数学 (CS101) | 周三 10:00 | `CS101-3-1000` |
| 大学英语 (EN102) | 周二 14:00 | `EN102-2-1400` |
| 大学英语 (EN102) | 周四 14:00 | `EN102-4-1400` |

**星期数字**：
- 1 = 周一
- 2 = 周二
- 3 = 周三
- 4 = 周四
- 5 = 周五
- 6 = 周六
- 7 = 周日

## 使用步骤

### 步骤1：删除旧课程数据

**方式1：使用Flask shell**
```python
flask shell

>>> from app.models import Course
>>> from app import db
>>> 
>>> # 删除所有课程（会级联删除相关的考勤记录）
>>> Course.query.delete()
>>> db.session.commit()
>>> print("旧课程数据已删除")
```

**方式2：使用SQL**
```sql
-- 连接数据库
psql -U your_username -d your_database

-- 删除所有课程
DELETE FROM course;
```

### 步骤2：重新导入ICS文件

1. 启动应用：
   ```bash
   flask run
   ```

2. 访问课程管理：
   ```
   http://127.0.0.1:5000/course/
   ```

3. 点击"导入ICS文件"

4. 上传 `230108.ics` 文件

5. 等待导入完成

### 步骤3：验证结果

**验证1：检查课程列表**
- 访问：`http://127.0.0.1:5000/course/`
- 检查：同一门课如果一周多次上课，应该显示多条记录

**示例**：
```
高等数学 - 周一 08:00-09:40 - 教学楼A201
高等数学 - 周三 10:00-11:40 - 教学楼A201
```

**验证2：检查考勤日历**
- 访问：`http://127.0.0.1:5000/attendance/`
- 选择有多次课的日期（如周一）
- 应该显示所有该天的课程

**验证3：测试记录考勤**
- 在考勤日历中点击某节课的"记录考勤"按钮
- 应该能正常打开考勤记录页面（不再404）

## 技术细节

### Course ID 长度

- **数据库定义**：`VARCHAR(20)`
- **生成的ID长度**：约15个字符（如：`CS101-1-0800`）
- **结论**：长度足够，无需修改数据库

### 唯一性保证

**唯一键组成**：
1. **课程代码**：从ICS的description字段提取
2. **星期数字**：从事件开始时间计算
3. **时间代码**：从事件开始时间提取

**示例**：
```python
# ICS事件1
课程代码: CS101
开始时间: 2025-09-01 08:00 (周一)
→ Course ID: CS101-1-0800

# ICS事件2
课程代码: CS101
开始时间: 2025-09-03 10:00 (周三)
→ Course ID: CS101-3-1000
```

### 周次信息的处理

周次信息仍然按课程记录收集：

```python
# CS101-1-0800 的周次
# 收集所有周一08:00的CS101课程的周次
weeks = {1, 2, 3, 4, 5, 6, 7, 8}
week_range = "1-8"

# CS101-3-1000 的周次
# 收集所有周三10:00的CS101课程的周次
weeks = {1, 2, 3, 4, 5, 6, 7, 8}
week_range = "1-8"
```

## 影响评估

### 对现有功能的影响

#### ✅ 不受影响的功能
- 考勤记录编辑
- 考勤统计
- 导出功能
- 周次过滤

#### ⚠️ 需要注意的变化
- **课程列表**：一门课一周多次上课会显示多条记录（正常行为）
- **Course ID**：不再是简单的课程代码，而是包含时间信息

### 数据迁移影响

**必须删除旧数据**：由于Course ID格式变化，旧数据无法自动迁移，必须删除后重新导入。

**级联影响**：
- 删除课程会级联删除相关的考勤记录（`ON DELETE CASCADE`）
- 建议在学期开始前或没有考勤记录时进行迁移

## 常见问题

### Q1：为什么不在原有课程上添加多个时间？

**A：** 考虑过使用JSON数组存储多个时间，但：
- 复杂化查询逻辑（需要解析JSON）
- 影响考勤记录关联（一对多变成多对多）
- 不利于独立管理每次上课的周次

当前方案更清晰：一条course记录 = 一次固定的上课时间

### Q2：同一门课的不同上课时间如何区分？

**A：** 通过Course ID区分：
```
CS101-1-0800  → 高等数学 周一 08:00
CS101-3-1000  → 高等数学 周三 10:00
```

在课程列表中会显示课程名称+时间+地点，用户很容易区分。

### Q3：如果某次上课的周次不同怎么办？

**A：** 完美支持！每条course记录都有独立的 `week_range`：
```
CS101-1-0800  week_range: 1-8      (前8周周一上课)
CS101-3-1000  week_range: 9-16     (后8周周三上课)
```

### Q4：导入后课程数量会增加吗？

**A：** 是的。如果一门课一周上2次，会创建2条记录。
- 导入前：可能显示30门课
- 导入后：可能显示50-60条课程记录（包含多次上课的）

这是**正常且正确**的行为。

### Q5：旧的考勤记录会丢失吗？

**A：** 是的，删除课程会级联删除考勤记录。建议：
1. **学期初迁移**：还没有考勤记录时
2. **导出备份**：如果有考勤记录，先导出备份
3. **学期结束后迁移**：下学期开始时重新导入

## 验证检查清单

完成以下检查，确保修复正确：

- [ ] 删除了旧的课程数据
- [ ] 重新从ICS文件导入课程
- [ ] 一周多次的课程显示多条记录
- [ ] 考勤日历正确显示所有课程
- [ ] 点击"记录考勤"不再404
- [ ] 考勤记录功能正常工作
- [ ] 周次过滤正常工作

## 示例验证

### 假设高等数学一周上3次

**ICS文件内容**：
```
课程代码: CS101
课程名称: 高等数学

事件1: 周一 08:00-09:40 (第1-8周)
事件2: 周三 10:00-11:40 (第1-8周)
事件3: 周五 14:00-15:40 (第1-8周)
```

**导入后的course表**：
```
course_id         course_name  course_time           week_range
CS101-1-0800     高等数学      周一 08:00-09:40      1-8
CS101-3-1000     高等数学      周三 10:00-11:40      1-8
CS101-5-1400     高等数学      周五 14:00-15:40      1-8
```

**考勤日历（第1周周一）**：
```
✅ 高等数学 - 周一 08:00-09:40 [记录考勤]
```

**考勤日历（第1周周三）**：
```
✅ 高等数学 - 周三 10:00-11:40 [记录考勤]
```

## 总结

1. **问题**：一周多次上课的课程只记录了一次
2. **根源**：ICS导入按课程代码去重
3. **解决**：为每个"课程代码+时间"创建唯一ID
4. **影响**：需要删除旧数据重新导入
5. **好处**：完整支持复杂的课程安排

修复后，系统可以完美处理：
- ✅ 一周多次上课
- ✅ 不同时间不同周次
- ✅ 灵活的课程安排

现在您可以删除旧数据并重新导入ICS文件了！🎉

