# 请假管理功能说明

## 功能概述

请假管理模块提供简单的请假记录和统计功能，不涉及审批流程，适用于直接记录学生请假情况。

## 主要功能

### 1. 请假列表 (`/leave/`)

**功能说明：**
- 分页显示所有请假记录
- 支持多条件筛选
- 快速操作（编辑、删除）

**筛选条件：**
- **搜索**：按学号或姓名搜索
- **请假类型**：病假、事假、其他
- **日期范围**：按开始/结束日期筛选

**显示信息：**
- 学生信息（学号、姓名）
- 请假类型（带颜色标识）
- 请假时间（开始-结束日期）
- 请假天数
- 请假原因（鼠标悬停查看完整内容）
- 提交时间

**操作按钮：**
- **导出Excel**：导出当前筛选结果
- **统计分析**：跳转到统计页面
- **添加请假**：添加新的请假记录
- **编辑**：修改请假记录
- **删除**：删除请假记录（需确认）

### 2. 添加/编辑请假 (`/leave/add`, `/leave/edit/<leave_id>`)

**表单字段：**
1. **学生**（必填）
   - 下拉选择框
   - 显示学号和姓名

2. **请假类型**（必填）
   - 病假
   - 事假
   - 其他

3. **开始日期**（必填）
   - 日期选择器
   - 自动验证（不能晚于结束日期）

4. **结束日期**（必填）
   - 日期选择器
   - 自动验证（不能早于开始日期）
   - 自动联动：开始日期改变时，结束日期自动调整

5. **请假原因**（必填）
   - 多行文本框
   - 详细说明请假原因

**自动计算：**
- 请假天数 = (结束日期 - 开始日期) + 1
- 提交时间自动记录

**表单验证：**
- 前端验证：日期合法性检查
- 后端验证：
  - 必填字段检查
  - 学生存在性验证
  - 日期逻辑验证

### 3. 请假统计 (`/leave/statistics`)

**统计维度：**

#### 总体统计
- **请假人次**：统计周期内的总请假次数
- **请假总天数**：累计请假时长

#### 按类型统计
- 病假：人次 + 天数
- 事假：人次 + 天数
- 其他：人次 + 天数
- 带颜色标识（病假-红、事假-蓝、其他-灰）

#### 请假次数排行
- 显示请假最多的前10名学生
- 包含学号、姓名、请假次数、累计天数
- 前3名特殊标识（金、银、铜）

#### 最近请假记录
- 显示最近10条请假记录
- 包含类型、学生、日期、天数
- 快速浏览最新动态

**日期筛选：**
- 默认显示本月数据
- 可自定义开始/结束日期
- 实时更新统计结果

### 4. 导出功能 (`/leave/export`)

**导出内容：**
- 根据当前筛选条件导出
- 包含所有列信息：
  - 学号
  - 姓名
  - 请假类型
  - 开始日期
  - 结束日期
  - 请假天数
  - 请假原因
  - 提交时间

**文件格式：**
- 格式：`.xlsx` (Excel 2007+)
- 文件名：`请假记录_YYYYMMDD_HHMMSS.xlsx`
- 样式：
  - 标题行：居中加粗
  - 表头：蓝底白字
  - 数据行：自动宽度、边框完整
  - 前6列居中对齐

## 技术实现

### 后端路由

| 路由 | 方法 | 说明 |
|------|------|------|
| `/leave/` | GET | 请假列表 |
| `/leave/add` | GET/POST | 添加请假记录 |
| `/leave/edit/<leave_id>` | GET/POST | 编辑请假记录 |
| `/leave/delete/<leave_id>` | POST | 删除请假记录 |
| `/leave/statistics` | GET | 请假统计 |
| `/leave/export` | GET | 导出请假记录 |

### 数据模型

使用 `LeaveRecord` 模型（`app/models/leave_record.py`）：
- `leave_id`：请假ID（主键，自增）
- `student_id`：学生ID（外键）
- `leave_type`：请假类型
- `leave_start_date`：开始日期
- `leave_end_date`：结束日期
- `leave_days`：请假天数
- `leave_reason`：请假原因
- `create_time`：创建时间（自动）

**数据库约束：**
- 外键约束：级联删除（删除学生时自动删除请假记录）
- 日期约束：结束日期 >= 开始日期

### 前端模板

- `app/templates/leave/index.html`：请假列表
- `app/templates/leave/form.html`：添加/编辑表单
- `app/templates/leave/statistics.html`：统计分析

### 依赖库

- `Flask`：Web 框架
- `SQLAlchemy`：ORM
- `openpyxl`：Excel 文件生成

## 使用场景

### 场景1：记录学生请假

**操作步骤：**
1. 访问请假管理页面
2. 点击"添加请假"
3. 选择学生、类型、日期
4. 填写请假原因
5. 点击"添加"保存

**示例：**
```
学生：张三 (230108001)
类型：病假
日期：2025-10-20 至 2025-10-22
天数：3天（自动计算）
原因：感冒发烧，需要休息
```

### 场景2：查询特定学生的请假记录

**操作步骤：**
1. 在搜索框输入学号或姓名
2. 点击"查询"
3. 查看该学生的所有请假记录

### 场景3：统计本月请假情况

**操作步骤：**
1. 点击"统计分析"
2. 查看本月总体数据
3. 查看按类型分布
4. 查看请假次数排行

### 场景4：导出请假数据

**操作步骤：**
1. 设置筛选条件（可选）
2. 点击"导出Excel"
3. 自动下载Excel文件

**用途：**
- 月度/学期请假汇总
- 向上级部门报告
- 数据备份归档

### 场景5：修改请假记录

**操作步骤：**
1. 在列表中找到要修改的记录
2. 点击"编辑"
3. 修改相应字段
4. 点击"更新"保存

### 场景6：删除错误记录

**操作步骤：**
1. 在列表中找到要删除的记录
2. 点击"删除"
3. 确认删除操作

## 业务规则

### 1. 请假天数计算

```python
请假天数 = (结束日期 - 开始日期) + 1

示例：
2025-10-20 至 2025-10-22 = 3天
2025-10-20 至 2025-10-20 = 1天
```

### 2. 日期验证

- 开始日期和结束日期都必须填写
- 结束日期不能早于开始日期
- 日期格式：YYYY-MM-DD

### 3. 数据完整性

- 学生必须存在于学生表
- 删除学生时，相关请假记录自动删除
- 提交时间自动记录，不可修改

### 4. 请假类型

目前支持三种类型：
- **病假**：因疾病需要休息
- **事假**：私人事务
- **其他**：其他原因

可根据需要扩展更多类型。

## 注意事项

1. **无审批流程**
   - 本模块仅用于记录和统计
   - 不包含申请、审批、撤回等流程
   - 记录即生效

2. **权限管理**
   - 当前版本无权限控制
   - 所有用户都可以添加/编辑/删除
   - 建议后续添加权限管理

3. **数据备份**
   - 建议定期导出数据备份
   - 删除操作不可恢复

4. **请假类型**
   - 下拉框中显示历史使用过的类型
   - 同时提供标准选项（病假、事假、其他）

5. **统计时间范围**
   - 统计默认显示本月数据
   - 可自定义任意时间范围
   - 跨月统计需手动设置日期

## 界面特点

### 颜色标识

- **病假**：红色背景 `bg-red-100 text-red-800`
- **事假**：蓝色背景 `bg-blue-100 text-blue-800`
- **其他**：灰色背景 `bg-gray-100 text-gray-800`

### 响应式设计

- 支持桌面、平板、手机
- 表格横向滚动（小屏幕）
- 表单字段自适应布局

### 交互体验

- 删除确认提示
- 表单前端验证
- Flash消息反馈
- 加载状态提示

## 后续扩展建议

### 1. 审批流程

如需添加审批功能：
- 添加 `status` 字段（待审批、已批准、已拒绝）
- 添加 `approver` 字段（审批人）
- 添加 `approve_time` 字段（审批时间）
- 添加 `approve_note` 字段（审批意见）

### 2. 学生自助申请

- 创建学生端界面
- 学生可以自己提交请假申请
- 查看自己的请假历史
- 接收审批结果通知

### 3. 请假凭证

- 添加附件上传功能
- 支持上传诊断书、证明等
- 图片预览和下载

### 4. 请假提醒

- 请假到期提醒
- 长期请假预警
- 频繁请假提醒

### 5. 统计增强

- 请假趋势图表
- 按班级统计
- 按月份对比
- 导出统计报表

### 6. 与考勤关联

- 请假期间考勤自动标记为"请假"
- 请假结束后自动恢复正常考勤
- 请假与缺勤的区分统计

## 常见问题

### Q1：如何批量导入历史请假记录？

**A：** 可以参考学生导入功能，创建一个批量导入页面：
```python
@leave_bp.route('/import', methods=['GET', 'POST'])
def import_records():
    # 解析Excel文件
    # 批量插入数据库
    pass
```

### Q2：请假天数计算是否包含周末？

**A：** 当前实现包含周末。如需排除周末，需修改天数计算逻辑：
```python
def calculate_leave_days(start_date, end_date):
    days = 0
    current_date = start_date
    while current_date <= end_date:
        if current_date.weekday() < 5:  # 周一到周五
            days += 1
        current_date += timedelta(days=1)
    return days
```

### Q3：如何导出某个学生的所有请假记录？

**A：** 在列表页面：
1. 搜索框输入学生学号或姓名
2. 点击"查询"
3. 点击"导出Excel"

### Q4：可以修改已有记录的提交时间吗？

**A：** 不可以。`create_time` 字段由数据库自动生成，记录创建时间不可修改。

### Q5：删除学生后，请假记录会怎样？

**A：** 请假记录会被自动删除（级联删除）。建议在删除学生前先导出相关数据备份。

## 总结

请假管理模块提供了：
1. ✅ 完整的CRUD功能
2. ✅ 多维度筛选查询
3. ✅ 统计分析功能
4. ✅ Excel导出功能
5. ✅ 用户友好的界面
6. ✅ 数据完整性保证

模块设计简洁实用，专注于记录和统计，无需复杂的审批流程，适合直接管理学生请假情况！🎉

