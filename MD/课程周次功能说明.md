# 课程周次功能说明

## 功能概述

系统已升级支持课程周次管理，可以准确记录每门课程的上课周次，在考勤日历中只显示当周应该上课的课程。

## 主要改进

### 1. 课程数据模型增强

**新增字段：`week_range`**
- 类型：VARCHAR(50)
- 说明：存储课程的上课周次范围
- 格式示例：
  - `1-8`：第1周到第8周连续上课
  - `9-16`：第9周到第16周连续上课
  - `1-8,13,15,17`：第1-8周连续，第13、15、17周单独上课
  - `1,3,5,7,9`：只在第1、3、5、7、9周上课

### 2. 学期周次配置

**第一周开始日期：2025年9月1日（周一）**

系统会根据当前日期自动计算是第几周，然后判断课程是否在该周上课。

**周次计算规则：**
- 从2025年9月1日开始计算
- 每7天为一周
- 最多支持20周（一个学期）

### 3. ICS导入自动解析周次

从ICS文件导入课程时，系统会：
1. 解析每个事件的"周次"信息（如："周次: 1"）
2. 收集同一门课的所有上课周次
3. 自动生成周次范围字符串（如：`1-8,13,15,17`）
4. 保存到 `week_range` 字段

**智能范围压缩：**
- 连续的周次会被压缩为范围：`[1,2,3,4,5,6,7,8]` → `1-8`
- 不连续的周次用逗号分隔：`[13,15,17]` → `13,15,17`
- 组合示例：`[1,2,3,4,5,6,7,8,13,15,17]` → `1-8,13,15,17`

### 4. 考勤日历智能过滤

**原逻辑：**
```
显示所有匹配星期几的课程（如：所有周一的课）
```

**新逻辑：**
```
1. 根据星期几查询课程（如：周一的课）
2. 计算当前日期是第几周
3. 判断每门课是否在该周上课
4. 只显示该周应该上课的课程
```

**示例：**
- 今天是2025年9月8日（第2周，周一）
- 系统找到所有周一的课程
- 过滤：只显示 `week_range` 包含"2"的课程
- 结果：
  - ✅ 高等数学（1-8周） - 显示
  - ✅ 大学英语（1-16周） - 显示
  - ❌ 专业选修课（9-16周） - 不显示

## 技术实现

### 数据库迁移

**执行迁移SQL：**
```bash
psql -U your_username -d your_database -f migrations/add_week_range_to_course.sql
```

或在 Flask shell 中：
```python
from app import db
db.session.execute("ALTER TABLE course ADD COLUMN IF NOT EXISTS week_range VARCHAR(50)")
db.session.commit()
```

### Course模型新增方法

**`is_teaching_week(week_number)` 方法：**
```python
# 判断课程是否在指定周次上课
course = Course.query.first()
course.is_teaching_week(3)  # 返回True或False
```

**实现逻辑：**
1. 解析 `week_range` 字符串（如："1-8,13,15,17"）
2. 转换为周次集合：`{1,2,3,4,5,6,7,8,13,15,17}`
3. 判断指定周次是否在集合中

### 周次计算工具

**`app/utils/week_helper.py` 提供以下函数：**

#### `get_week_number(target_date)`
计算指定日期是第几周：
```python
from app.utils.week_helper import get_week_number
from datetime import date

# 2025-09-01 是第1周
week = get_week_number(date(2025, 9, 1))  # 返回 1

# 2025-09-08 是第2周
week = get_week_number(date(2025, 9, 8))  # 返回 2
```

#### `get_week_date_range(week_number)`
获取指定周次的日期范围：
```python
from app.utils.week_helper import get_week_date_range

# 获取第2周的日期范围
start, end = get_week_date_range(2)
# 返回：(2025-09-08, 2025-09-14)
```

#### `get_current_week()`
获取当前是第几周：
```python
from app.utils.week_helper import get_current_week

current_week = get_current_week()  # 返回当前周次
```

#### `is_in_week_range(week_number, week_range_str)`
判断周次是否在范围内：
```python
from app.utils.week_helper import is_in_week_range

# 判断第3周是否在"1-8"范围内
is_in_week_range(3, "1-8")  # 返回 True

# 判断第10周是否在"1-8,13,15,17"范围内
is_in_week_range(10, "1-8,13,15,17")  # 返回 False
```

#### `format_week_range(week_range_str)`
格式化周次范围显示：
```python
from app.utils.week_helper import format_week_range

format_week_range("1-8")  # 返回："第1-8周"
format_week_range("1-8,13,15,17")  # 返回："第1-8周、第13周、第15周、第17周"
```

### 配置说明

**学期开始日期配置：**

在 `app/utils/week_helper.py` 中：
```python
# 第一周的开始日期：2025年9月1日
FIRST_WEEK_START = date(2025, 9, 1)
```

如需修改学期开始日期，只需更改这个常量。

## 使用指南

### 1. 导入课程（推荐方式）

**从ICS文件导入：**
1. 访问：`/course/import_ics`
2. 上传包含周次信息的ICS文件
3. 系统自动解析并填充 `week_range` 字段

**ICS文件要求：**
- 事件描述必须包含"周次: X"格式
- 系统会自动收集所有周次并生成范围字符串

### 2. 手动添加/编辑课程

如果手动添加或编辑课程，需要指定 `week_range`：

**格式要求：**
- 连续范围：`开始周-结束周`（如：`1-8`）
- 单独周次：用逗号分隔（如：`13,15,17`）
- 组合：`范围,单独,范围`（如：`1-8,13,15,17,9-16`）

**示例：**
```python
from app.models import Course

# 创建全学期课程（1-16周）
course1 = Course(
    course_id='CS101',
    course_name='高等数学',
    teacher_name='张老师',
    course_time='周一 08:00-09:40',
    course_place='教学楼A201',
    semester='2025-2026学年第一学期',
    week_range='1-16'
)

# 创建前半学期课程（1-8周）
course2 = Course(
    course_id='CS102',
    course_name='大学英语',
    teacher_name='李老师',
    course_time='周三 14:00-15:40',
    course_place='教学楼B302',
    semester='2025-2026学年第一学期',
    week_range='1-8'
)

# 创建特定周次课程
course3 = Course(
    course_id='CS103',
    course_name='专题讲座',
    teacher_name='王老师',
    course_time='周五 10:00-11:40',
    course_place='阶梯教室',
    semester='2025-2026学年第一学期',
    week_range='1-8,13,15,17'
)
```

### 3. 查看考勤日历

访问考勤日历时，系统会自动：
1. 计算当前日期是第几周
2. 根据星期几和周次过滤课程
3. 只显示本周应该上课的课程

**用户无需任何操作，系统自动处理。**

### 4. 导出考勤数据

导出功能也会自动根据周次过滤：
- **导出当天**：只导出该天该周应该上课的课程
- **导出本周**：遍历每一天，只导出对应周次应该上课的课程

## 测试验证

### 测试场景1：第1周（2025-09-01 至 2025-09-07）

**测试步骤：**
1. 导入包含不同周次的课程
2. 访问考勤日历，选择2025-09-01（第1周周一）
3. 验证只显示 `week_range` 包含"1"的周一课程

**预期结果：**
- ✅ 显示：高等数学（1-16周）
- ✅ 显示：大学英语（1-8周）
- ❌ 不显示：专业选修（9-16周）

### 测试场景2：第9周（2025-10-27 至 2025-11-02）

**测试步骤：**
1. 访问考勤日历，选择2025-10-27（第9周周一）
2. 验证课程显示正确

**预期结果：**
- ✅ 显示：高等数学（1-16周）
- ❌ 不显示：大学英语（1-8周）
- ✅ 显示：专业选修（9-16周）

### 测试场景3：特定周次课程

**测试数据：**
```
课程名称：专题讲座
上课时间：周五 10:00-11:40
周次范围：1-8,13,15,17
```

**测试步骤：**
1. 访问第1周周五 → ✅ 应该显示
2. 访问第9周周五 → ❌ 不应该显示
3. 访问第13周周五 → ✅ 应该显示
4. 访问第14周周五 → ❌ 不应该显示
5. 访问第15周周五 → ✅ 应该显示

### 测试场景4：导出功能

**测试步骤：**
1. 选择第9周的任意日期
2. 点击"导出当天"
3. 打开Excel文件

**预期结果：**
- ✅ 只包含第9周应该上课的课程
- ❌ 不包含1-8周的课程

### 测试场景5：跨学期处理

**测试步骤：**
1. 选择2025年7月的日期（学期开始前）
2. 访问考勤日历

**预期结果：**
- 显示所有匹配星期几的课程（因为不在学期范围内）

## 数据迁移

### 现有课程数据处理

对于已经导入的课程（没有 `week_range` 字段），有两种处理方式：

#### 方式1：重新导入ICS文件

1. 删除现有课程数据
2. 重新从ICS文件导入（推荐）

```python
from app.models import Course
from app import db

# 删除所有课程
Course.query.delete()
db.session.commit()

# 然后通过Web界面重新导入ICS文件
```

#### 方式2：手动更新week_range

```python
from app.models import Course
from app import db

# 更新所有课程的week_range为全学期
courses = Course.query.all()
for course in courses:
    course.week_range = '1-16'  # 根据实际情况修改
db.session.commit()
```

## 常见问题

### Q1：第一周开始日期如何修改？

**A：** 修改 `app/utils/week_helper.py` 中的 `FIRST_WEEK_START` 常量：
```python
FIRST_WEEK_START = date(2025, 9, 1)  # 修改为实际开学日期
```

### Q2：课程的 `week_range` 为空会怎样？

**A：** 如果 `week_range` 为 `None` 或空字符串，系统会认为该课程每周都上课。

### Q3：如何处理调课或临时停课？

**A：** 有两种方式：
1. 修改课程的 `week_range`，去掉特定周次
2. 在考勤记录中备注说明

### Q4：一学期超过20周怎么办？

**A：** 修改 `app/utils/week_helper.py` 中的 `get_week_number` 函数：
```python
# 修改最大周次限制
if week_number > 25:  # 改为25周
    return None
```

### Q5：课程在不同周的上课时间不同怎么办？

**A：** 目前系统不支持这种情况。建议创建两门课程，分别设置不同的 `course_time` 和 `week_range`。

## 后续优化建议

### 1. 前端可视化周次选择

在课程添加/编辑页面，提供图形化的周次选择器：
```
□ 第1周  □ 第2周  □ 第3周  □ 第4周
□ 第5周  □ 第6周  □ 第7周  □ 第8周
...
```

### 2. 周次范围验证

在表单提交前验证 `week_range` 格式：
```python
def validate_week_range(week_range_str):
    # 验证格式是否正确
    # 1-8,13,15,17 ✓
    # 1-8-16 ✗
    pass
```

### 3. 学期配置管理

将学期开始日期存入配置表或配置文件：
```python
# config.py
SEMESTER_START_DATE = '2025-09-01'
SEMESTER_WEEKS = 16
```

### 4. 课程日历可视化

在课程详情页显示该课程的上课周次日历：
```
第1周  第2周  第3周  第4周  第5周  第6周  第7周  第8周
  ✓     ✓     ✓     ✓     ✓     ✓     ✓     ✓
第9周  第10周 第11周 第12周 第13周 第14周 第15周 第16周
  ✗     ✗     ✗     ✗     ✓     ✗     ✓     ✗
```

### 5. 批量调整周次

提供批量调整功能：
- 整体向后推迟（如：放假顺延）
- 批量添加/删除周次

## 总结

通过支持课程周次管理，系统能够：
1. ✅ 准确显示每周应该上课的课程
2. ✅ 自动从ICS文件解析周次信息
3. ✅ 智能过滤考勤日历和导出数据
4. ✅ 支持灵活的周次配置（连续、不连续、组合）
5. ✅ 提供完整的周次计算工具库

这使得考勤管理更加准确和高效！🎉

