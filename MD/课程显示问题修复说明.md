# 课程显示问题修复说明

## 问题描述

在考勤日历视图中，课程没有显示。

## 问题原因

课程数据的 `course_time` 字段存储的是 **星期+时间** 的格式，例如：
- `周一 08:00-09:40`
- `周二 14:00-15:40`
- `周五 10:00-11:40`

但原来的代码在查询课程时，尝试使用 **具体日期**（如 `2025-10-25`）来匹配 `course_time` 字段：

```python
# 错误的查询方式
courses = Course.query.filter(
    Course.course_time.like(f'%{current_date.strftime("%Y-%m-%d")}%')
).order_by(Course.course_time).all()
```

这导致无法匹配到任何课程，因为 `course_time` 中不包含日期信息。

## 解决方案

修改查询逻辑，根据 **日期对应的星期几** 来查询课程：

```python
# 正确的查询方式
weekday_names = ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
current_weekday = weekday_names[current_date.weekday()]
courses = Course.query.filter(
    Course.course_time.like(f'{current_weekday}%')
).order_by(Course.course_time).all()
```

例如：
- 如果 `current_date` 是 2025-10-25（星期六），则 `current_weekday` = "周六"
- 查询条件变为：`course_time LIKE '周六%'`
- 这样就能匹配到所有周六的课程

## 修复位置

已修复以下三个函数中的课程查询逻辑：

### 1. 考勤日历视图 (`index` 函数)

**文件**：`app/routes/attendance.py` 第 29-35 行

**修改前**：
```python
courses = Course.query.filter(
    Course.course_time.like(f'%{current_date.strftime("%Y-%m-%d")}%')
).order_by(Course.course_time).all()
```

**修改后**：
```python
weekday_names = ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
current_weekday = weekday_names[current_date.weekday()]
courses = Course.query.filter(
    Course.course_time.like(f'{current_weekday}%')
).order_by(Course.course_time).all()
```

### 2. 导出当天考勤 (`export_day` 函数)

**文件**：`app/routes/attendance.py` 第 243-249 行

**修改前**：
```python
courses = Course.query.filter(
    Course.course_time.like(f'%{export_date.strftime("%Y-%m-%d")}%')
).order_by(Course.course_time).all()
```

**修改后**：
```python
weekday_names = ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
export_weekday = weekday_names[export_date.weekday()]
courses = Course.query.filter(
    Course.course_time.like(f'{export_weekday}%')
).order_by(Course.course_time).all()
```

### 3. 导出本周考勤 (`export_week` 函数)

**文件**：`app/routes/attendance.py` 第 389-403 行

**修改前**：
```python
courses = Course.query.filter(
    Course.course_time.like(f'%{current_day.strftime("%Y-%m-%d")}%')
).order_by(Course.course_time).all()

# ...
weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
date_cell.value = f"{current_day.strftime('%Y年%m月%d日')} {weekdays[day_offset]}"
```

**修改后**：
```python
weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
current_weekday = weekdays[current_day.weekday()]
courses = Course.query.filter(
    Course.course_time.like(f'{current_weekday}%')
).order_by(Course.course_time).all()

# ...
date_cell.value = f"{current_day.strftime('%Y年%m月%d日')} {current_weekday}"
```

**额外修复**：同时修正了星期几的计算，从 `day_offset` 改为 `current_day.weekday()`，确保星期显示正确。

## 验证方法

### 1. 检查课程数据

首先确认课程数据已导入，并查看 `course_time` 字段的格式：

```python
# 在 Flask shell 中执行
flask shell

>>> from app.models.course import Course
>>> courses = Course.query.all()
>>> for c in courses:
...     print(f"{c.course_id}: {c.course_name} - {c.course_time}")
```

应该看到类似：
```
CS101: 高等数学 - 周一 08:00-09:40
CS102: 大学英语 - 周三 14:00-15:40
```

### 2. 测试考勤日历视图

1. 启动应用：`flask run`
2. 访问：`http://127.0.0.1:5000/attendance/`
3. 检查当天是否显示课程：
   - 如果今天是周一，应该显示所有 `course_time` 以"周一"开头的课程
   - 如果今天是周五，应该显示所有 `course_time` 以"周五"开头的课程
4. 切换到其他日期，检查课程是否正确显示

### 3. 测试日期切换

1. 点击"前一天"/"后一天"按钮
2. 课程列表应该根据星期几动态变化
3. 点击周历中的任意一天，应该跳转并显示对应星期的课程

### 4. 测试导出功能

1. 选择一个有课的日期（如周一）
2. 点击"导出当天"按钮
3. 打开下载的 Excel 文件，检查是否包含该天的课程数据
4. 点击"导出本周"按钮
5. 检查 Excel 文件中每一天的课程是否正确

## 注意事项

### 1. 课程时间格式要求

从 ICS 文件导入的课程，`course_time` 格式必须是：
```
{星期} {开始时间}-{结束时间}
```

例如：
- ✅ 正确：`周一 08:00-09:40`
- ✅ 正确：`周五 14:00-15:40`
- ❌ 错误：`Monday 08:00-09:40`（英文星期）
- ❌ 错误：`2025-10-25 08:00-09:40`（包含日期）

### 2. 星期索引

Python 的 `datetime.weekday()` 返回值：
- 0 = 周一
- 1 = 周二
- 2 = 周三
- 3 = 周四
- 4 = 周五
- 5 = 周六
- 6 = 周日

我们的 `weekday_names` 数组正好对应这个索引。

### 3. 周末课程

如果周六或周日有课程，系统会正常显示和处理。

### 4. 跨学期问题

当前实现根据星期几匹配课程，不区分学期和周次。如果需要更精确的控制：
- 可以在查询时增加 `semester` 条件
- 或者在数据库中增加 `week_range`（周次范围）字段

## 测试清单

- [ ] 课程数据已从 ICS 文件导入
- [ ] 课程的 `course_time` 格式正确（周X XX:XX-XX:XX）
- [ ] 考勤日历能正确显示当天课程
- [ ] 日期切换时课程列表正确更新
- [ ] 周历导航能正确跳转
- [ ] "导出当天"功能正常，数据正确
- [ ] "导出本周"功能正常，每天的数据正确
- [ ] 周末日期也能正确查询课程

## 后续优化建议

### 1. 增加学期过滤

在查询时增加学期条件，避免显示其他学期的课程：

```python
from config import Config  # 假设配置中有当前学期

courses = Course.query.filter(
    Course.course_time.like(f'{current_weekday}%'),
    Course.semester == Config.CURRENT_SEMESTER
).order_by(Course.course_time).all()
```

### 2. 增加周次支持

在 `Course` 表中增加 `week_range` 字段（如："1-16"表示第1周到第16周），查询时判断当前周次是否在范围内。

### 3. 缓存优化

将课程列表缓存起来，减少数据库查询：

```python
from flask_caching import Cache

@cache.memoize(timeout=300)  # 缓存5分钟
def get_courses_by_weekday(weekday):
    return Course.query.filter(
        Course.course_time.like(f'{weekday}%')
    ).order_by(Course.course_time).all()
```

### 4. 创建课程日程表

创建一个单独的 `CourseSchedule` 表，存储每节课的具体上课日期：

```python
class CourseSchedule(db.Model):
    schedule_id = db.Column(db.Integer, primary_key=True)
    course_id = db.Column(db.String(20), db.ForeignKey('course.course_id'))
    class_date = db.Column(db.Date, nullable=False)
    start_time = db.Column(db.Time, nullable=False)
    end_time = db.Column(db.Time, nullable=False)
```

这样查询会更精确，但需要在导入 ICS 时为每节课的每次上课都创建记录。

## 总结

修复完成后，考勤日历视图能够：
1. ✅ 正确显示当天的课程
2. ✅ 根据日期切换正确更新课程列表
3. ✅ 正确导出每天和每周的考勤数据

问题的根本原因是**日期格式与存储格式不匹配**，修复方法是**将日期转换为星期几再进行查询**。

