# 考勤记录功能说明

## 功能概述

考勤记录模块提供了以每天课程为视图的考勤管理功能，支持查询历史记录、批量修改考勤状态、导出每周或每天的考勤数据。

## 主要功能

### 1. 考勤日历视图 (`/attendance/`)

**功能说明：**
- 以日历形式展示课程考勤
- 显示当天所有课程及其考勤统计
- 支持快速切换日期（前一天/后一天/今天）
- 显示本周日历，快速跳转到任意一天

**页面元素：**
- **日期导航**：左右箭头切换日期，"今天"按钮快速返回当天
- **周历视图**：显示本周七天，点击日期快速跳转
- **课程列表**：显示当天所有课程，包含：
  - 课程基本信息（名称、时间、地点、教师、学期）
  - 考勤统计（应到、实到、请假、旷课、到勤率）
  - 记录状态（已记录/未记录）
  - 操作按钮（记录考勤/编辑考勤）
- **导出按钮**：
  - 导出当天考勤记录
  - 导出本周考勤统计
  - 查看历史记录

**考勤统计说明：**
- 到勤率 = (实到人数 / 应到人数) × 100%
- 颜色标识：
  - 绿色：到勤率 ≥ 90%
  - 黄色：80% ≤ 到勤率 < 90%
  - 红色：到勤率 < 80%

### 2. 考勤记录编辑 (`/attendance/record/<course_id>`)

**功能说明：**
- 为特定课程记录或修改考勤
- 首次访问自动创建默认记录（所有学生默认到课）
- 支持批量设置考勤状态
- 实时统计各状态人数

**操作步骤：**
1. 从日历视图点击"记录考勤"或"编辑考勤"按钮
2. 系统自动为该课程创建默认考勤记录（所有学生到课）
3. 逐个修改学生的考勤状态：
   - **考勤状态**：到课 / 请假 / 旷课
   - **迟到时长**：输入迟到分钟数（可选）
   - **备注信息**：填写额外说明（可选）
4. 使用快捷操作：
   - "全部到课"：将所有学生设为到课
   - "全部请假"：将所有学生设为请假
   - "全部旷课"：将所有学生设为旷课
5. 点击"保存考勤记录"提交

**页面特性：**
- 表格展示所有学生
- 实时统计面板显示：
  - 总人数
  - 到课人数（绿色）
  - 请假人数（黄色）
  - 旷课人数（红色）
- 快捷批量操作按钮
- 提交前确认提示

### 3. 历史考勤查询 (`/attendance/history`)

**功能说明：**
- 查询和管理历史考勤数据
- 支持多条件筛选
- 分页展示记录
- 快速跳转到详情编辑

**筛选条件：**
- **开始日期**：查询起始日期
- **结束日期**：查询结束日期
- **课程**：选择特定课程（或全部课程）

**显示信息：**
- 日期
- 课程名称
- 应到人数
- 实到人数
- 请假人数
- 旷课人数
- 到勤率（带颜色标识）
- 操作（查看/编辑）

**分页功能：**
- 每页显示 15 条记录
- 支持上一页/下一页
- 显示页码导航
- 显示当前记录范围和总数

### 4. 导出每天考勤 (`/attendance/export_day`)

**功能说明：**
- 导出指定日期的所有课程考勤记录
- 生成格式化的 Excel 文件
- 包含考勤统计信息

**导出内容：**
- 文件标题：YYYY年MM月DD日 课程考勤记录
- 表头：课程名称、上课时间、上课地点、应到人数、实到人数、到勤率
- 数据行：当天所有课程的考勤统计

**文件格式：**
- 格式：`.xlsx` (Excel 2007+)
- 文件名：`YYYYMMDD_考勤记录.xlsx`
- 样式：
  - 标题居中加粗
  - 表头蓝底白字
  - 数据居中对齐
  - 全表格边框

### 5. 导出每周考勤 (`/attendance/export_week`)

**功能说明：**
- 导出指定日期所在周的所有考勤记录
- 按天分组显示
- 包含详细的考勤统计

**导出内容：**
- 文件标题：YYYY年MM月DD日 - YYYY年MM月DD日 课程考勤统计
- 按天分组：
  - 日期标题（含星期）
  - 该天所有课程的考勤数据
- 表头：课程名称、上课时间、上课地点、应到、实到、请假、旷课
- 数据行：每节课的详细考勤数据

**文件格式：**
- 格式：`.xlsx` (Excel 2007+)
- 文件名：`YYYYMMDD-YYYYMMDD_周考勤统计.xlsx`
- 样式：
  - 标题居中加粗
  - 日期标题浅蓝底
  - 表头蓝底白字
  - 数据居中对齐
  - 全表格边框
  - 各天之间空行分隔

## 技术实现

### 后端路由

| 路由 | 方法 | 说明 |
|------|------|------|
| `/attendance/` | GET | 考勤日历视图 |
| `/attendance/record/<course_id>` | GET | 考勤记录编辑页面 |
| `/attendance/save` | POST | 保存考勤记录 |
| `/attendance/export_day` | GET | 导出当天考勤 |
| `/attendance/export_week` | GET | 导出本周考勤 |
| `/attendance/history` | GET | 历史考勤查询 |

### 数据模型

使用 `Attendance` 模型（`app/models/attendance.py`）：
- `attendance_id`：考勤ID（主键）
- `student_id`：学生ID（外键）
- `course_id`：课程ID（外键）
- `attendance_date`：考勤日期
- `attendance_type`：考勤类型（到课/请假/旷课）
- `late_minutes`：迟到时长（分钟）
- `attendance_note`：备注信息
- `create_time`：创建时间

### 前端模板

- `app/templates/attendance/index.html`：考勤日历视图
- `app/templates/attendance/record.html`：考勤记录编辑
- `app/templates/attendance/history.html`：历史记录查询

### 依赖库

- `Flask`：Web 框架
- `SQLAlchemy`：ORM
- `openpyxl`：Excel 文件生成

## 使用说明

### 1. 记录今日考勤

1. 点击左侧导航"考勤记录"或首页"记录考勤"
2. 在日历视图中查看今天的课程
3. 点击某节课的"记录考勤"按钮
4. 系统自动创建默认记录（所有学生到课）
5. 根据实际情况修改学生状态
6. 点击"保存考勤记录"

### 2. 查看历史考勤

1. 在考勤日历页面，切换日期查看
2. 或点击"历史记录"进入查询页面
3. 设置筛选条件（日期范围、课程）
4. 点击"查询"查看结果
5. 点击"查看/编辑"可修改历史记录

### 3. 导出考勤数据

**导出当天：**
1. 在考勤日历页面选择日期
2. 点击"导出当天"按钮
3. 浏览器自动下载 Excel 文件

**导出本周：**
1. 在考勤日历页面选择任意日期
2. 点击"导出本周"按钮
3. 系统自动导出该日期所在周的数据

### 4. 修改考勤记录

1. 进入历史记录查询页面
2. 找到要修改的记录
3. 点击"查看/编辑"
4. 修改考勤状态
5. 保存更改

## 注意事项

1. **默认考勤创建**：
   - 首次访问某课程的考勤记录时，系统自动为所有学生创建"到课"记录
   - 您只需修改实际缺勤或请假的学生

2. **数据完整性**：
   - 考勤记录与学生、课程关联
   - 删除学生或课程会级联删除相关考勤记录

3. **到勤率计算**：
   - 到勤率 = 实到人数 / 应到人数 × 100%
   - 实到 = 考勤状态为"到课"的人数
   - 应到 = 系统中的学生总数

4. **导出文件**：
   - 导出的 Excel 文件已格式化，可直接使用
   - 文件名包含日期，便于归档管理

5. **性能优化**：
   - 历史记录采用分页显示，每页 15 条
   - 建议定期备份导出的考勤数据

## 后续扩展建议

1. **考勤分析**：
   - 学生个人出勤统计
   - 课程出勤趋势分析
   - 异常考勤提醒

2. **请假关联**：
   - 自动将批准的请假记录同步到考勤
   - 请假凭证附件管理

3. **移动端支持**：
   - 响应式设计优化
   - 扫码签到功能

4. **通知提醒**：
   - 旷课学生短信/邮件提醒
   - 低出勤率课程预警

5. **权限管理**：
   - 教师只能管理自己的课程考勤
   - 学生只能查看自己的考勤记录

